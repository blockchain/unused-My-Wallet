var BlockchainAPI=new function(){var b=this;var c=60000;var a=2;(function(d){d.retryAjax=function(g){var f;g.tryCount=(!g.tryCount)?0:g.tryCount;g.retryLimit=(!g.retryLimit)?a:g.retryLimit;g.suppressErrors=true;if(g.error){f=g.error;delete g.error}else{f=function(){}}g.complete=function(h,i){if(d.inArray(i,["timeout","abort","error"])>-1){this.tryCount++;if(this.tryCount<=this.retryLimit){if(this.tryCount===this.retryLimit){this.error=f;delete this.suppressErrors}d.ajax(this);return true}return true}};d.ajax(g)}}(jQuery));this.get_history=function(i,d,f,h,k){MyWallet.setLoadingText("Loading transactions");var j=(new Date()).getTime();if(!f){f=0}if(!h){h=0}if(!k){k=0}var g={active:MyWallet.getActiveAddresses().join("|"),format:"json",filter:f,offset:h,no_compact:true,ct:j,n:k,language:MyWallet.getLanguage(),symbol_btc:symbol_btc.code,symbol_local:symbol_local.code};$.retryAjax({type:"POST",dataType:"json",url:root+"multiaddr",data:g,timeout:c,success:function(m){if(m.error!=null){MyWallet.makeNotice("error","misc-error",m.error)}MyWallet.handleNTPResponse(m,j);try{if(h==0&&f==0){MyStore.put("multiaddr",JSON.stringify(m))}i(m)}catch(l){MyWallet.makeNotice("error","misc-error",l);d()}},error:function(l){if(l.responseText){MyWallet.makeNotice("error","misc-error",l.responseText)}else{MyWallet.makeNotice("error","misc-error","Error Downloading Wallet Balance")}d()}})};this.get_balances=function(g,f,d){MyWallet.setLoadingText("Getting Balances");$.ajax({type:"POST",url:root+"multiaddr",dataType:"json",timeout:c,data:{active:g.join("|"),simple:true,format:"json"},success:function(i){for(var h in i){if(MyWallet.addressExists(h)){MyWallet.setAddressBalance(h,i[h].final_balance)}}f(i)},error:function(h){d(h.responseText)}})};this.get_balance=function(g,f,d){MyWallet.setLoadingText("Getting Balance");this.get_balances(g,function(j){var i=0;for(var h in j){i+=j[h].final_balance}f(i)},d)};this.get_ticker=function(){MyWallet.setLoadingText("Getting Ticker Data");$.ajax({type:"GET",dataType:"json",url:root+"ticker",data:{format:"json"},timeout:c,success:function(g){var d=$("#send-ticker ul").empty();for(var f in g){d.append('<li><div style="width:35px;padding-left:10px;font-weight:bold;display:inline-block">'+f+'</div>  <i class="icon-user" style="background-image:url('+resource+((g[f]["15m"]>=g[f]["24h"])?"up_green.png":"down_red.png")+');width:14px;background-position:0px"></i>'+g[f]["15m"]+"</li>")}},error:function(d){console.log(d)}})};this.resolve_firstbits=function(g,f,d){MyWallet.setLoadingText("Querying Firstbits");$.ajax({type:"GET",url:root+"q/resolvefirstbits/"+g,data:{format:"plain"},timeout:c,success:function(h){if(h==null||h.length==0){d()}else{f(h)}},error:function(h){d(h.responseText)}})};this.get_rejection_reason=function(h,d,f,g){MyWallet.setLoadingText("Querying Rejection Reason");$.ajax({type:"GET",url:root+"q/rejected/"+h,data:{format:"plain"},timeout:c,success:function(i){if(i==null||i.length==0){g()}else{if(i=="Transaction Not Rejected"){f()}else{d(i)}}},error:function(i){g(i.responseText)}})};this.push_tx=function(u,f,h,p){try{var r=function(){if(j){clearInterval(j);j=null}if(h){h();h=null}};var g=function(s){if(j){clearInterval(j);j=null}if(p){p();p=null}};MyWallet.setLoadingText("Pushing Transaction");var o=MyWallet.getTransactions();if(o.length>0){var n=o[0].txIndex}var k=u.serialize();var w=Crypto.util.bytesToHex(Crypto.SHA256(Crypto.SHA256(k,{asBytes:true}),{asBytes:true}).reverse());var i=function(){r();function s(){MyWallet.get_history(function(){if(o.length==0||o[0].txIndex==n){b.get_rejection_reason(w,function(x){MyWallet.makeNotice("error","tx-error",x)},function(){if(o.length==0||o[0].txIndex==n){MyWallet.get_history()}},function(){if(o.length==0||o[0].txIndex==n){MyWallet.makeNotice("error","tx-error","Unknown Error Pushing Transaction")}})}else{playSound("beep")}},function(){MyWallet.makeNotice("error","tx-error","Unable to determine if transaction was submitted. Please re-login.")})}setTimeout(function(){if(o.length==0||o[0].txIndex==n){s()}},3000)};var j=setInterval(function(){b.get_rejection_reason(w,function(s){console.log(s)},function(){if(i){i();i=null}clearInterval(j);j=null},function(s){console.log(s)})},5000);function v(){var s=Crypto.util.bytesToHex(k);var x={format:"plain",tx:s,hash:w};if(f){x.note=f}$.ajax({type:"POST",url:root+"pushtx",timeout:c,data:x,success:function(){if(i){i();i=null}},error:function(y){g(y?y.responseText:null)}})}try{var q=new ArrayBuffer(k.length);var m=new Int8Array(q);m.set(k);var d=new Blob([q],{type:"application/octet-stream"});if(d.size!=k.length){throw"Inconsistent Data Sizes (blob : "+d.size+" s : "+k.length+" buffer : "+q.byteLength+")"}var l=new FormData();l.append("txbytes",d);if(f){l.append("note",f)}l.append("format","plain");l.append("hash",w);$.ajax({url:root+"pushtx",data:l,processData:false,contentType:false,timeout:c,type:"POST",success:function(){if(i){i();i=null}},error:function(s){if(!s.responseText||s.responseText.indexOf("Parse:")==0){setTimeout(function(){v()},2000)}else{g(s?s.responseText:null)}}})}catch(t){console.log(t);v()}}catch(t){console.log(t);g(t)}};this.get_unspent=function(g,i,f,h,d){MyWallet.setLoadingText("Getting Unspent Outputs");$.retryAjax({type:"POST",dataType:"json",url:root+"unspent",timeout:c,data:{active:g.join("|"),format:"json",confirmations:h?h:0},success:function(k){try{if(k.error!=null){throw k.error}if(k.notice!=null){MyWallet.makeNotice("notice","misc-notice",k.notice)}MyStore.put("unspent",JSON.stringify(k));i(k)}catch(j){f(j)}},error:function(j){if(d){f(e)}else{MyStore.get("unspent",function(k){try{if(k!=null){var m=$.parseJSON(k);i(m)}else{if(j.responseText){throw j.responseText}else{throw"Error Contacting Server. No unspent outputs available in cache."}}}catch(l){f(l)}})}}})}};