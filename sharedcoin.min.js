var SharedCoin=new function(){var g=this;var d={};var b=2;var a=MyWallet.getSharedcoinEndpoint()+"?version="+b;var f={};var e="sharedcoin-seed:";var c={show:function(){var h=this;h.modal=$("#sharedcoin-modal");h.modal.modal({keyboard:false,backdrop:"static",show:true});h.modal.find(".btn.btn-secondary").unbind().click(function(){h.hide()})},setAddressAndAmount:function(h,i){if(this.modal){this.modal.find(".total_value").text(formatBTC(i));this.modal.find(".address").text(h)}},hide:function(){if(this.modal){this.modal.modal("hide")}},disableCancel:function(){if(this.modal){this.modal.find(".alert-warning").show();this.modal.find(".alert-error").hide();this.modal.find(".btn.btn-secondary").prop("disabled",true)}},enableCancel:function(){if(this.modal){this.modal.find(".alert-error").show();this.modal.find(".alert-warning").hide();this.modal.find(".btn.btn-secondary").prop("disabled",false)}}};this.newProposal=function(){return{_pollForCompleted:function(j,i){var h=this;console.log("Offer._pollForCompleted()");MyWallet.setLoadingText("Waiting For Others Participants To Sign");$.ajax({dataType:"json",type:"POST",url:a,data:{method:"poll_for_proposal_completed",format:"json",proposal_id:h.proposal_id},success:function(k){j(k)},error:function(k){i(k.responseText)}})},pollForCompleted:function(k,i){var h=this;var j=function(l){if(l.status=="waiting"){h._pollForCompleted(j,i)}else{if(l.status=="not_found"){i("Proposal ID Not Found")}else{if(l.status=="complete"){k(l.tx_hash)}else{i("Unknown status "+l.status)}}}};h._pollForCompleted(j,i)}}};this.newOffer=function(){return{offered_outpoints:[],request_outputs:[],offer_id:0,submit:function(j,i){var h=this;MyWallet.setLoadingText("Submitting Offer");$.ajax({dataType:"json",type:"POST",url:a,data:{method:"submit_offer",format:"json",offer:JSON.stringify(h)},success:function(k){if(!k.offer_id){i("Null offer_id returned")}else{h.offer_id=k.offer_id;j()}},error:function(k){i(k.responseText)}})},_pollForProposalID:function(j,i){var h=this;console.log("Offer._pollForProposalID()");MyWallet.setLoadingText("Waiting For Other Participants");$.ajax({dataType:"json",type:"POST",url:a,data:{method:"get_offer_id",format:"json",offer_id:h.offer_id},success:function(k){j(k)},error:function(k){i(k.responseText)}})},calculateFee:function(){var h=this;var l=BigInteger.ZERO;for(var j in h.offered_outpoints){l=l.add(BigInteger.valueOf(h.offered_outpoints[j].value))}var k=BigInteger.ZERO;for(var j in h.request_outputs){k=k.add(BigInteger.valueOf(h.request_outputs[j].value))}return l.subtract(k)},pollForProposalID:function(k,i){var h=this;var j=function(l){if(l.status=="waiting"){h._pollForProposalID(j,i)}else{if(l.status=="not_found"){i("Offer ID Not Found")}else{if(l.status=="active_proposal"){k(l.proposal_id)}else{i("Unknown status "+l.status)}}}};h._pollForProposalID(j,i)},getProposal:function(j,k,i){var h=this;console.log("SharedCoin.getProposal()");MyWallet.setLoadingText("Fetching Proposal");$.ajax({dataType:"json",type:"POST",url:a,data:{method:"get_proposal_id",format:"json",offer_id:h.offer_id,proposal_id:j},success:function(m){var l=g.newProposal();var n=jQuery.extend(l,m);if(n.status=="not_found"){i("Proposal or Offer ID Not Found")}else{k(n)}},error:function(l){i(l.responseText)}})},isOutpointOneWeOffered:function(i){var h=this;var k=i.outpoint.hash;var n=Crypto.util.bytesToHex(Crypto.util.base64ToBytes(k).reverse());var j=i.outpoint.index;for(var l in h.offered_outpoints){var m=h.offered_outpoints[l];if(m.hash.toString()==n.toString()&&m.index.toString()==j.toString()){return true}}return false},isOutputOneWeRequested:function(j){var i=this;var n=j.value.slice(0);n.reverse();var h=Crypto.util.bytesToHex(j.script.buffer);var m=new BigInteger(n);for(var k in i.request_outputs){var l=i.request_outputs[k];if(l.script.toString()==h.toString()&&m.toString()==l.value.toString()){return true}}return false},isOutputChange:function(j){var i=this;var n=j.value.slice(0);n.reverse();var h=Crypto.util.bytesToHex(j.script.buffer);var m=new BigInteger(n);for(var k in i.request_outputs){var l=i.request_outputs[k];if(l.script.toString()==h.toString()&&m.toString()==l.value.toString()){return l.exclude_from_fee}}return false},checkProposal:function(p,t,q){console.log("Offer.checkProposal()");var v=this;try{if(p.tx==null){throw"Proposal Transaction Is Null"}var k=Crypto.util.hexToBytes(p.tx);Bitcoin.Transaction.deserialize=function(E){var G=new Bitcoin.Transaction();G.version=readUInt32(E);var A=readVarInt(E).intValue();for(var F=0;F<A;F++){var B=E.splice(0,32);var y=Crypto.util.bytesToBase64(B);var w=readUInt32(E);var D=readVarInt(E).intValue();var H=new Bitcoin.Script(E.splice(0,D));var z=readUInt32(E);var I=new Bitcoin.TransactionIn({outpoint:{hash:y,index:w},script:H,sequence:z});G.ins.push(I)}var J=readVarInt(E).intValue();for(var F=0;F<J;F++){var x=E.splice(0,8);var D=readVarInt(E).intValue();var H=new Bitcoin.Script(E.splice(0,D));var C=new Bitcoin.TransactionOut({script:H,value:x});G.outs.push(C)}G.lock_time=readUInt32(E);return G};var m=Bitcoin.Transaction.deserialize(k);if(m==null){throw"Error deserializing transaction"}var r=[];var u=0;for(var l=0;l<m.outs.length;++l){if(v.isOutputOneWeRequested(m.outs[l])){if(!v.isOutputChange(m.outs[l])){var o=m.outs[l].value.slice(0);o.reverse();var s=new BigInteger(o);r.push({hash:null,index:parseInt(l),value:s.toString()})}++u}}if(u<v.request_outputs.length){throw"Could not find all our requested outputs ("+u+" < "+v.request_outputs.length+")"}var j=0;for(var l=0;l<p.signature_requests.length;++l){var h=p.signature_requests[l].tx_input_index;if(v.isOutpointOneWeOffered(m.ins[h])){++j}}if(v.offered_outpoints.length!=j){throw"Could not find all our offered outpoints ("+v.offered_outpoints.length+" != "+j+")"}t(m,r)}catch(n){q(n)}},signNormal:function(h,l,n,k){console.log("Offer.signNormal()");var j=0;var m=[];var i=function(){setTimeout(function(){try{var o=l[j];var q=signInput(h,o.tx_input_index,o.priv_to_use,o,SIGHASH_ALL);if(q){j++;m.push({tx_input_index:o.tx_input_index,input_script:Crypto.util.bytesToHex(q.buffer),offer_outpoint_index:o.offer_outpoint_index});if(j==l.length){n(m)}else{i()}}else{throw"Unknown error signing transaction"}}catch(p){k(p)}},1)};i()},submitInputScripts:function(j,k,l,i){console.log("Offer.submitInputScripts()");var h=this;MyWallet.setLoadingText("Submitting Signatures");$.ajax({dataType:"json",type:"POST",url:a,data:{method:"submit_signatures",format:"json",input_scripts:JSON.stringify(k),offer_id:h.offer_id,proposal_id:j.proposal_id},success:function(m){if(m.status=="not_found"){i("Proposal Expired or Not Found")}else{if(m.status=="verification_failed"){i("Signature Verification Failed")}else{if(m.status=="complete"){i("Transaction Already Completed")}else{if(m.status=="signatures_accepted"){l("Signatures Accepted")}else{i("Unknown status "+m.status)}}}}},error:function(m){i(m.responseText)}})},signInputs:function(q,n,t,r){console.log("Offer.signInputs()");var u=this;try{var o={};var j=[];for(var m=0;m<q.signature_requests.length;++m){var l=q.signature_requests[m];var s=new Bitcoin.Script(Crypto.util.hexToBytes(l.connected_script));s.tx_input_index=l.tx_input_index;s.offer_outpoint_index=l.offer_outpoint_index;var h=s.simpleOutPubKeyHash();var k=new Bitcoin.Address(h).toString();if(o[k]){s.priv_to_use=o[k]}else{if(f[k]){s.priv_to_use=Bitcoin.Base58.decode(f[k])}else{if(MyWallet.addressExists(k)&&!MyWallet.isWatchOnly(k)){s.priv_to_use=MyWallet.decodePK(MyWallet.getPrivateKey(k))}}}if(s.priv_to_use==null){throw"Private key not found"}else{o[k]=s.priv_to_use}j.push(s)}u.signNormal(n,j,function(i){t(i)},function(i){r(i)})}catch(p){r(p)}}}};this.generateAddressFromCustomSeed=function(i,l){var k=Crypto.SHA256(i+l,{asBytes:true});var j=new Bitcoin.ECKey(k);if(k[0]%2==0){var h=j.getBitcoinAddress()}else{var h=j.getBitcoinAddressCompressed()}f[h.toString()]=Bitcoin.Base58.encode(j.priv);return h};this.newPlan=function(){return{offers:[],n_stages:0,address_seed:new SecureRandom().nextBytes(16),address_seen_n:0,generateAddressFromSeed:function(){if(this.address_seed==null){var i=[];i.length=18;new SecureRandom().nextBytes(i);this.address_seed=Crypto.util.bytesToHex(i);MyWallet.addAdditionalSeeds(e+this.address_seed)}var h=g.generateAddressFromCustomSeed(e+this.address_seed,this.address_seen_n);this.address_seen_n++;return h},executeOffer:function(i,j,h){i.submit(function(){console.log("Successfully Submitted Offer");i.pollForProposalID(function(k){console.log("Proposal ID "+k);i.getProposal(k,function(l){console.log("Got Proposal");i.checkProposal(l,function(m,n){console.log("Proposal Looks Good");i.signInputs(l,m,function(o){console.log("Inputs Signed");i.submitInputScripts(l,o,function(p){console.log("Submitted Input Scripts");l.pollForCompleted(function(r){console.log("Poll For Completed Success");for(var q in n){n[q].hash=r}j(n)},h)},h)},h)},h)},h)},h)},h)},execute:function(k,i){var h=this;var j=function(l){var m=h.offers[l];console.log("Executing Stage "+l);h.executeOffer(m,function(n){l++;if(l<h.n_stages){h.offers[l].offered_outpoints=n;j(l)}else{if(l==h.n_stages){k()}}},i)};MyWallet.backupWallet("update",function(){console.log("Saved Wallet");j(0)},i)},constructRepetitions:function(k,p,q,B){try{var z=this;var r=BigInteger.ZERO;for(var C in k.offered_outpoints){r=r.add(BigInteger.valueOf(k.offered_outpoints[C].value))}var j=r;for(var v=0;v<z.n_stages-1;++v){var h=g.newOffer();if(v==0){for(var C in k.request_outputs){if(k.request_outputs[C].exclude_from_fee){var t=k.request_outputs.splice(C,1)[0];h.request_outputs.push(t);console.log("changeoutput.value "+t.value);j=j.subtract(BigInteger.valueOf(t.value));break}}h.offered_outpoints=k.offered_outpoints.slice(0);k.offered_outpoints=[]}j=j.subtract(p[v]);var o=[10,5,1,0.5,0.1];var w=15;var s=false;while(true){var E=Math.random();var A=1;if(E>=0.75){A=3}else{if(E>=0.25){A=2}}for(var x in o){var n=(o[x]/100)*((Math.random()*30)-15);var l=BigInteger.valueOf(Math.round((o[x]+n)*satoshi));var u=j.divideAndRemainder(l);if(u[0].intValue()>=A&&u[0].intValue()<=w){if(u[1].compareTo(BigInteger.ZERO)==0||u[1].compareTo(BigInteger.valueOf(g.getMinimumOutputValue()))>=0){for(var y=0;y<u[0].intValue();++y){var m=z.generateAddressFromSeed();h.request_outputs.push({value:l.toString(),script:Crypto.util.bytesToHex(Script.createOutputScript(m).buffer)})}if(u[1].compareTo(BigInteger.ZERO)>0){var m=z.generateAddressFromSeed();h.request_outputs.push({value:u[1].toString(),script:Crypto.util.bytesToHex(Script.createOutputScript(m).buffer)})}s=true;break}}}if(s){break}}z.offers.push(h)}z.offers.push(k);q(z)}catch(D){B(D)}}}};this.generateNewAddress=function(l,h){try{var i=MyWallet.generateNewKey();var k=i.getBitcoinAddress();MyWallet.setAddressLabel(k.toString(),"SharedCoin Change");l(k)}catch(j){h(j)}};this.getMinimumOutputValue=function(){return d.minimum_output_value};this.getMinimumInputValue=function(){return d.minimum_input_value};this.getMinimumSupportedVersion=function(){return d.min_supported_version};this.getIsEnabled=function(){return d.enabled};this.getMaximumOutputValue=function(){return d.maximum_output_value};this.getFee=function(){return d.fee_percent};this.getMinimumFee=function(){return d.minimum_fee?d.minimum_fee:0};this.constructPlan=function(n,y,v){try{var k=n.find('select[name="repetitions"]');var r=parseInt(k.val());if(r<=0){throw"invalid number of repetitions"}var s=initNewTx();var h=n.find('select[name="from"]');var o=h.val();if(o==null||o=="any"){s.from_addresses=MyWallet.getActiveAddresses()}else{if(h.attr("multiple")=="multiple"){s.from_addresses=o}else{s.from_addresses=[o]}}var j=n.find(".recipient");j.each(function(){try{var E=$(this);var D=E.find('input[name="send-value"]');var A=E.find('input[name="send-to-address"]');var B=0;try{B=precisionToSatoshiBN(D.val());if(B==null||B.compareTo(BigInteger.ZERO)<=0){throw"You must enter a value greater than zero"}}catch(C){throw"Invalid send amount"}var i=$.trim(A.val()).replace(/[\u200B-\u200D\uFEFF]/g,"");if(i==null||i.length==0){throw"You must enter a bitcoin address for each recipient"}var z=resolveAddress(i);if(z==null||z.length==0){throw"You must enter a bitcoin address for each recipient"}s.to_addresses.push({address:new Bitcoin.Address(z),value:B})}catch(C){v(C)}});if(s.to_addresses.length==0||s.to_addresses.length<j.length){return}var m=[];var w=[];for(var q in s.to_addresses){var p=s.to_addresses[q];m.push(p.value);for(var x=r-1;x>=0;--x){var u=g.calculateFeeForValue(p.value);p.value=p.value.add(u);var l=w[x];if(l){w[x]=l.add(u)}else{w[x]=u}}}g.generateNewAddress(function(i){s.min_input_confirmations=1;s.allow_adjust=false;s.change_address=i;s.base_fee=BigInteger.ZERO;s.min_input_size=BigInteger.valueOf(g.getMinimumInputValue());s.min_free_output_size=BigInteger.valueOf(g.getMinimumOutputValue());s.fee=BigInteger.ZERO;s.ask_for_fee=function(B,A){A()};var z=g.newOffer();s.signInputs=function(){try{var L=this;for(var D=0;D<L.tx.ins.length;++D){var J=L.tx.ins[D];var B=J.outpoint.hash;var I=Crypto.util.bytesToHex(Crypto.util.base64ToBytes(B).reverse());z.offered_outpoints.push({hash:I,index:J.outpoint.index,value:J.outpoint.value.toString()})}for(var D=0;D<L.tx.outs.length;++D){var C=L.tx.outs[D];var G=C.value.slice(0);G.reverse();var K=new BigInteger(G);var A=new Bitcoin.Script(C.script).simpleOutPubKeyHash();var F=new Bitcoin.Address(A).toString();if(F.toString()==i.toString()){z.request_outputs.push({value:K.toString(),script:Crypto.util.bytesToHex(C.script.buffer),exclude_from_fee:true})}else{z.request_outputs.push({value:m[D].toString(),script:Crypto.util.bytesToHex(C.script.buffer)})}}var H=g.newPlan();H.n_stages=r;H.c_stage=0;H.constructRepetitions(z,w,y,function(M){v(M)})}catch(E){v(E)}};s.addListener({on_error:function(A){v()}});s.start()},function(i){v(i)})}catch(t){MyWallet.makeNotice("error","misc-error",t)}};this.calculateFeeForValue=function(i){if(i.compareTo(BigInteger.ZERO)>0){var k=Math.ceil(100/g.getFee());var h=i.divide(BigInteger.valueOf(k));var j=BigInteger.valueOf(g.getMinimumFee());if(j.compareTo(h)>0){return j}else{return h}}else{return BigInteger.ZERO}};this.init=function(j){$("#additional_seeds").remove();var o=MyWallet.getAdditionalSeeds();var k=[];for(var q in o){var n=o[q];if(n.indexOf(e)==0){k.push(n)}}if(k.length>0){var i=$('<div class="well" id="additional_seeds"></div>');for(var q in k){(function(s){var t=$("<p>"+s+' - (<a href="#">Recover</a>)</p>');i.append(t);t.find("a").click(function(){var v=[];for(var u=0;u<100;++u){v.push(g.generateAddressFromCustomSeed(s,u).toString())}MyWallet.sweepAddressesModal(v,f)})})(k[q])}j.append(i)}var r=j.find(".send");var p=j.find(".send-options");var h=j.find('select[name="repetitions"]');r.unbind().prop("disabled",true);j.find('input[name="send-value"]').bind("keyup change",function(){m()});p.hide();function l(){var s=p.find("span");s.eq(0).text(formatBTC(g.getMaximumOutputValue()));s.eq(1).text(formatBTC(g.getMinimumOutputValue()));s.eq(2).text(g.getFee());s.eq(3).text(formatBTC(g.getMinimumFee()));p.show()}function m(){var t=parseInt(h.val());if(t>0&&g.getIsEnabled()&&b>=g.getMinimumSupportedVersion()){var s=precisionToSatoshiBN(j.find('input[name="send-value"]').val());if(s.compareTo(BigInteger.valueOf(g.getMinimumOutputValue()))<0){r.prop("disabled",true)}else{if(s.compareTo(BigInteger.valueOf(g.getMaximumOutputValue()))>0){r.prop("disabled",true)}else{r.prop("disabled",false);r.unbind().click(function(){MyWallet.disableLogout(true);var u=function(w){j.find("input,select,button").prop("disabled",false);m();MyWallet.disableLogout(false);MyWallet.makeNotice("error","misc-error",w);c.enableCancel()};var v=function(){j.find("input,select,button").prop("disabled",false);MyWallet.makeNotice("success","misc-success","Sharedcoin Transaction Successfully Completed");MyWallet.disableLogout(false);c.hide();m()};MyWallet.getSecondPassword(function(){loadScript("wallet/signer",function(){c.show();c.disableCancel();var x=precisionToSatoshiBN(j.find('input[name="send-value"]').val());var w=j.find('input[name="send-to-address"]').val();c.setAddressAndAmount(w,x);j.find("input,select,button").prop("disabled",true);g.constructPlan(j,function(y){console.log("Created Plan");console.log(y);y.execute(v,u)},u)},u)},u)})}}}else{r.prop("disabled",true)}}if($.isEmptyObject(d)){MyWallet.setLoadingText("Fetching SharedCoin Info");$.ajax({dataType:"json",type:"POST",url:a,data:{method:"get_info",format:"json"},success:function(u){try{d=u;if(!g.getIsEnabled()){throw"Shared Coin is currently disabled"}if(b<g.getMinimumSupportedVersion()){throw"Version out of date. Please update your client or reload the page."}l();h.empty();for(var s=u.recommended_min_iterations;s<=u.recommended_max_iterations;s+=1){h.append('<option value="'+(s)+'">'+(s)+" Repetitions (Fee: "+((s)*g.getFee()).toFixed(3)+"%)</option>")}h.val(u.recommended_iterations)}catch(t){MyWallet.makeNotice("error","misc-error",t)}m()},error:function(s){r.prop("disabled",true);MyWallet.makeNotice("error","misc-error",s.responseText)}})}else{l()}}};