var SharedCoin=new function(){var h=this;var d={};var b=2;var a=MyWallet.getSharedcoinEndpoint()+"?version="+b;var g={};var f="sharedcoin-seed:";function e(o,r){var p=[];var j=Math.round(o*1/r);var q=Math.round(0.5*j);var l=0;for(var k=0;k<r;k++){var m=Math.floor((Math.random()*j)+q);if(l+m>o||k==r-1){m=o-l}l+=m;p[k]=m;if(l==o){break}}return p}var c={show:function(){var i=this;i.modal=$("#sharedcoin-modal");i.modal.modal({keyboard:false,backdrop:"static",show:true});i.modal.find(".btn.btn-secondary").unbind().click(function(){i.hide()})},setAddressAndAmount:function(i,j){if(this.modal){this.modal.find(".total_value").text(formatBTC(j));this.modal.find(".address").text(i)}},hide:function(){if(this.modal){this.modal.modal("hide")}},disableCancel:function(){if(this.modal){this.modal.find(".alert-warning").show();this.modal.find(".alert-error").hide();this.modal.find(".btn.btn-secondary").prop("disabled",true)}},enableCancel:function(){if(this.modal){this.modal.find(".alert-error").show();this.modal.find(".alert-warning").hide();this.modal.find(".btn.btn-secondary").prop("disabled",false)}}};this.newProposal=function(){return{_pollForCompleted:function(k,j){var i=this;console.log("Offer._pollForCompleted()");MyWallet.setLoadingText("Waiting For Others Participants To Sign");$.ajax({dataType:"json",type:"POST",url:a,data:{method:"poll_for_proposal_completed",format:"json",proposal_id:i.proposal_id},success:function(l){k(l)},error:function(l){j(l.responseText)}})},pollForCompleted:function(l,j){var i=this;var k=function(m){if(m.status=="waiting"){i._pollForCompleted(k,j)}else{if(m.status=="not_found"){j("Proposal ID Not Found")}else{if(m.status=="complete"){l(m.tx_hash)}else{j("Unknown status "+m.status)}}}};i._pollForCompleted(k,j)}}};this.newOffer=function(){return{offered_outpoints:[],request_outputs:[],offer_id:0,submit:function(k,j){var i=this;MyWallet.setLoadingText("Submitting Offer");$.ajax({dataType:"json",type:"POST",url:a,data:{method:"submit_offer",format:"json",offer:JSON.stringify(i)},success:function(l){if(!l.offer_id){j("Null offer_id returned")}else{i.offer_id=l.offer_id;k()}},error:function(l){j(l.responseText)}})},_pollForProposalID:function(k,j){var i=this;console.log("Offer._pollForProposalID()");MyWallet.setLoadingText("Waiting For Other Participants");$.ajax({dataType:"json",type:"POST",url:a,data:{method:"get_offer_id",format:"json",offer_id:i.offer_id},success:function(l){k(l)},error:function(l){j(l.responseText)}})},calculateFee:function(){var j=this;var m=BigInteger.ZERO;for(var k in j.offered_outpoints){m=m.add(BigInteger.valueOf(j.offered_outpoints[k].value))}var l=BigInteger.ZERO;for(var k in j.request_outputs){l=l.add(BigInteger.valueOf(j.request_outputs[k].value))}return m.subtract(l)},pollForProposalID:function(l,j){var i=this;var k=function(m){if(m.status=="waiting"){i._pollForProposalID(k,j)}else{if(m.status=="not_found"){j("Offer ID Not Found")}else{if(m.status=="active_proposal"){l(m.proposal_id)}else{j("Unknown status "+m.status)}}}};i._pollForProposalID(k,j)},getProposal:function(k,l,j){var i=this;console.log("SharedCoin.getProposal()");MyWallet.setLoadingText("Fetching Proposal");$.ajax({dataType:"json",type:"POST",url:a,data:{method:"get_proposal_id",format:"json",offer_id:i.offer_id,proposal_id:k},success:function(n){var m=h.newProposal();var o=jQuery.extend(m,n);if(o.status=="not_found"){j("Proposal or Offer ID Not Found")}else{l(o)}},error:function(m){j(m.responseText)}})},isOutpointOneWeOffered:function(j){var i=this;var l=j.outpoint.hash;var o=Crypto.util.bytesToHex(Crypto.util.base64ToBytes(l).reverse());var k=j.outpoint.index;for(var m in i.offered_outpoints){var n=i.offered_outpoints[m];if(n.hash.toString()==o.toString()&&n.index.toString()==k.toString()){return true}}return false},isOutputOneWeRequested:function(k){var j=this;var o=k.value.slice(0);o.reverse();var i=Crypto.util.bytesToHex(k.script.buffer);var n=new BigInteger(o);for(var l in j.request_outputs){var m=j.request_outputs[l];if(m.script.toString()==i.toString()&&n.toString()==m.value.toString()){return true}}return false},isOutputChange:function(k){var j=this;var o=k.value.slice(0);o.reverse();var i=Crypto.util.bytesToHex(k.script.buffer);var n=new BigInteger(o);for(var l in j.request_outputs){var m=j.request_outputs[l];if(m.script.toString()==i.toString()&&n.toString()==m.value.toString()){return m.exclude_from_fee}}return false},checkProposal:function(q,u,r){console.log("Offer.checkProposal()");var w=this;try{if(q.tx==null){throw"Proposal Transaction Is Null"}var l=Crypto.util.hexToBytes(q.tx);Bitcoin.Transaction.deserialize=function(F){var H=new Bitcoin.Transaction();H.version=readUInt32(F);var B=readVarInt(F).intValue();for(var G=0;G<B;G++){var C=F.splice(0,32);var z=Crypto.util.bytesToBase64(C);var x=readUInt32(F);var E=readVarInt(F).intValue();var I=new Bitcoin.Script(F.splice(0,E));var A=readUInt32(F);var J=new Bitcoin.TransactionIn({outpoint:{hash:z,index:x},script:I,sequence:A});H.ins.push(J)}var K=readVarInt(F).intValue();for(var G=0;G<K;G++){var y=F.splice(0,8);var E=readVarInt(F).intValue();var I=new Bitcoin.Script(F.splice(0,E));var D=new Bitcoin.TransactionOut({script:I,value:y});H.outs.push(D)}H.lock_time=readUInt32(F);return H};var n=Bitcoin.Transaction.deserialize(l);if(n==null){throw"Error deserializing transaction"}var s=[];var v=0;for(var m=0;m<n.outs.length;++m){if(w.isOutputOneWeRequested(n.outs[m])){if(!w.isOutputChange(n.outs[m])){var p=n.outs[m].value.slice(0);p.reverse();var t=new BigInteger(p);s.push({hash:null,index:parseInt(m),value:t.toString()})}++v}}if(v<w.request_outputs.length){throw"Could not find all our requested outputs ("+v+" < "+w.request_outputs.length+")"}var k=0;for(var m=0;m<q.signature_requests.length;++m){var j=q.signature_requests[m].tx_input_index;if(w.isOutpointOneWeOffered(n.ins[j])){++k}}if(w.offered_outpoints.length!=k){throw"Could not find all our offered outpoints ("+w.offered_outpoints.length+" != "+k+")"}u(n,s)}catch(o){r(o)}},signNormal:function(i,m,o,l){console.log("Offer.signNormal()");var k=0;var n=[];var j=function(){setTimeout(function(){try{var p=m[k];var r=signInput(i,p.tx_input_index,p.priv_to_use,p,SIGHASH_ALL);if(r){k++;n.push({tx_input_index:p.tx_input_index,input_script:Crypto.util.bytesToHex(r.buffer),offer_outpoint_index:p.offer_outpoint_index});if(k==m.length){o(n)}else{j()}}else{throw"Unknown error signing transaction"}}catch(q){l(q)}},1)};j()},submitInputScripts:function(k,l,m,j){console.log("Offer.submitInputScripts()");var i=this;MyWallet.setLoadingText("Submitting Signatures");$.ajax({dataType:"json",type:"POST",url:a,data:{method:"submit_signatures",format:"json",input_scripts:JSON.stringify(l),offer_id:i.offer_id,proposal_id:k.proposal_id},success:function(n){if(n.status=="not_found"){j("Proposal Expired or Not Found")}else{if(n.status=="verification_failed"){j("Signature Verification Failed")}else{if(n.status=="complete"){j("Transaction Already Completed")}else{if(n.status=="signatures_accepted"){m("Signatures Accepted")}else{j("Unknown status "+n.status)}}}}},error:function(n){j(n.responseText)}})},signInputs:function(r,o,u,s){console.log("Offer.signInputs()");var v=this;try{var p={};var k=[];for(var n=0;n<r.signature_requests.length;++n){var m=r.signature_requests[n];var t=new Bitcoin.Script(Crypto.util.hexToBytes(m.connected_script));t.tx_input_index=m.tx_input_index;t.offer_outpoint_index=m.offer_outpoint_index;var j=t.simpleOutPubKeyHash();var l=new Bitcoin.Address(j).toString();if(p[l]){t.priv_to_use=p[l]}else{if(g[l]){t.priv_to_use=Bitcoin.Base58.decode(g[l])}else{if(MyWallet.addressExists(l)&&!MyWallet.isWatchOnly(l)){t.priv_to_use=MyWallet.decodePK(MyWallet.getPrivateKey(l))}}}if(t.priv_to_use==null){throw"Private key not found"}else{p[l]=t.priv_to_use}k.push(t)}v.signNormal(o,k,function(i){u(i)},function(i){s(i)})}catch(q){s(q)}}}};this.generateAddressFromCustomSeed=function(j,m){var l=Crypto.SHA256(j+m,{asBytes:true});var k=new Bitcoin.ECKey(l);if(l[0]%2==0){var i=k.getBitcoinAddress()}else{var i=k.getBitcoinAddressCompressed()}g[i.toString()]=Bitcoin.Base58.encode(k.priv);return i};this.newPlan=function(){return{offers:[],n_stages:0,address_seed:new SecureRandom().nextBytes(16),address_seen_n:0,generateAddressFromSeed:function(){if(this.address_seed==null){var j=[];j.length=18;new SecureRandom().nextBytes(j);this.address_seed=Crypto.util.bytesToHex(j);MyWallet.addAdditionalSeeds(f+this.address_seed)}var i=h.generateAddressFromCustomSeed(f+this.address_seed,this.address_seen_n);this.address_seen_n++;return i},executeOffer:function(j,k,i){j.submit(function(){console.log("Successfully Submitted Offer");j.pollForProposalID(function(l){console.log("Proposal ID "+l);j.getProposal(l,function(m){console.log("Got Proposal");j.checkProposal(m,function(n,o){console.log("Proposal Looks Good");j.signInputs(m,n,function(p){console.log("Inputs Signed");j.submitInputScripts(m,p,function(q){console.log("Submitted Input Scripts");m.pollForCompleted(function(s){console.log("Poll For Completed Success");for(var r in o){o[r].hash=s}k(o)},i)},i)},i)},i)},i)},i)},i)},execute:function(l,j){var i=this;var k=function(m){var n=i.offers[m];console.log("Executing Stage "+m);i.executeOffer(n,function(o){m++;if(m<i.n_stages){i.offers[m].offered_outpoints=o;k(m)}else{if(m==i.n_stages){l()}}},j)};MyWallet.backupWallet("update",function(){console.log("Saved Wallet");k(0)},j)},constructRepetitions:function(m,r,s,F){try{var C=this;var t=BigInteger.ZERO;for(var G in m.offered_outpoints){t=t.add(BigInteger.valueOf(m.offered_outpoints[G].value))}var l=t;for(var y=0;y<C.n_stages-1;++y){var k=h.newOffer();if(y==0){for(var G in m.request_outputs){if(m.request_outputs[G].exclude_from_fee){var w=m.request_outputs.splice(G,1)[0];k.request_outputs.push(w);l=l.subtract(BigInteger.valueOf(w.value));break}}k.offered_outpoints=m.offered_outpoints.slice(0);m.offered_outpoints=[]}l=l.subtract(r[y]);var q=[10,5,1,0.5,0.3,0.1];var z=10;var I=Math.random();var D=1;if(I>=0.66){D=3}else{if(I>=0.33){D=2}}var u=false;while(true){for(var A in q){var p=(q[A]/100)*((Math.random()*30)-15);var n=BigInteger.valueOf(Math.round((q[A]+p)*satoshi));var x=l.divideAndRemainder(n);var j=x[0].intValue();if(j>=D&&j<=z){if(x[1].compareTo(BigInteger.ZERO)==0||x[1].compareTo(BigInteger.valueOf(h.getMinimumOutputValue()))>=0){var v=[];if(x[1].compareTo(BigInteger.ZERO)>0){if(j<=1){var o=C.generateAddressFromSeed();k.request_outputs.push({value:x[1].toString(),script:Crypto.util.bytesToHex(Script.createOutputScript(o).buffer)})}else{v=e(x[1].intValue(),j)}}for(var B=0;B<j;++B){var o=C.generateAddressFromSeed();var E=n;if(v[B]&&v[B]>0){E=E.add(BigInteger.valueOf(v[B]))}k.request_outputs.push({value:E.toString(),script:Crypto.util.bytesToHex(Script.createOutputScript(o).buffer)})}u=true;break}}}if(u){break}}C.offers.push(k)}C.offers.push(m);s(C)}catch(H){F(H)}}}};this.generateNewAddress=function(m,i){try{var j=MyWallet.generateNewKey();var l=j.getBitcoinAddress();MyWallet.setAddressLabel(l.toString(),"SharedCoin Change");m(l)}catch(k){i(k)}};this.getMinimumOutputValue=function(){return d.minimum_output_value};this.getMinimumInputValue=function(){return d.minimum_input_value};this.getMinimumSupportedVersion=function(){return d.min_supported_version};this.getIsEnabled=function(){return d.enabled};this.getMaximumOutputValue=function(){return d.maximum_output_value};this.getFee=function(){return d.fee_percent};this.getMinimumFee=function(){return d.minimum_fee?d.minimum_fee:0};this.constructPlan=function(o,z,w){try{var l=o.find('select[name="repetitions"]');var s=parseInt(l.val());if(s<=0){throw"invalid number of repetitions"}var t=initNewTx();var j=o.find('select[name="from"]');var p=j.val();if(p==null||p=="any"){t.from_addresses=MyWallet.getActiveAddresses()}else{if(j.attr("multiple")=="multiple"){t.from_addresses=p}else{t.from_addresses=[p]}}var k=o.find(".recipient");k.each(function(){try{var F=$(this);var E=F.find('input[name="send-value"]');var B=F.find('input[name="send-to-address"]');var C=0;try{C=precisionToSatoshiBN(E.val());if(C==null||C.compareTo(BigInteger.ZERO)<=0){throw"You must enter a value greater than zero"}}catch(D){throw"Invalid send amount"}var i=$.trim(B.val()).replace(/[\u200B-\u200D\uFEFF]/g,"");if(i==null||i.length==0){throw"You must enter a bitcoin address for each recipient"}var A=resolveAddress(i);if(A==null||A.length==0){throw"You must enter a bitcoin address for each recipient"}t.to_addresses.push({address:new Bitcoin.Address(A),value:C})}catch(D){w(D)}});if(t.to_addresses.length==0||t.to_addresses.length<k.length){return}var n=[];var x=[];for(var r in t.to_addresses){var q=t.to_addresses[r];n.push(q.value);for(var y=s-1;y>=0;--y){var v=h.calculateFeeForValue(q.value);q.value=q.value.add(v);var m=x[y];if(m){x[y]=m.add(v)}else{x[y]=v}}}h.generateNewAddress(function(i){t.min_input_confirmations=1;t.allow_adjust=false;t.change_address=i;t.base_fee=BigInteger.ZERO;t.min_input_size=BigInteger.valueOf(h.getMinimumInputValue());t.min_free_output_size=BigInteger.valueOf(h.getMinimumOutputValue());t.fee=BigInteger.ZERO;t.ask_for_fee=function(C,B){B()};var A=h.newOffer();t.signInputs=function(){try{var M=this;for(var E=0;E<M.tx.ins.length;++E){var K=M.tx.ins[E];var C=K.outpoint.hash;var J=Crypto.util.bytesToHex(Crypto.util.base64ToBytes(C).reverse());A.offered_outpoints.push({hash:J,index:K.outpoint.index,value:K.outpoint.value.toString()})}for(var E=0;E<M.tx.outs.length;++E){var D=M.tx.outs[E];var H=D.value.slice(0);H.reverse();var L=new BigInteger(H);var B=new Bitcoin.Script(D.script).simpleOutPubKeyHash();var G=new Bitcoin.Address(B).toString();if(G.toString()==i.toString()){A.request_outputs.push({value:L.toString(),script:Crypto.util.bytesToHex(D.script.buffer),exclude_from_fee:true})}else{A.request_outputs.push({value:n[E].toString(),script:Crypto.util.bytesToHex(D.script.buffer)})}}var I=h.newPlan();I.n_stages=s;I.c_stage=0;I.constructRepetitions(A,x,z,function(N){w(N)})}catch(F){w(F)}};t.addListener({on_error:function(B){w()}});t.start()},function(i){w(i)})}catch(u){MyWallet.makeNotice("error","misc-error",u)}};this.calculateFeeForValue=function(j){if(j.compareTo(BigInteger.ZERO)>0){var l=Math.ceil(100/h.getFee());var i=j.divide(BigInteger.valueOf(l));var k=BigInteger.valueOf(h.getMinimumFee());if(k.compareTo(i)>0){return k}else{return i}}else{return BigInteger.ZERO}};this.init=function(k){$("#additional_seeds").remove();var p=MyWallet.getAdditionalSeeds();var l=[];for(var r in p){var o=p[r];if(o.indexOf(f)==0){l.push(o)}}if(l.length>0){var j=$('<div class="well" id="additional_seeds"></div>');for(var r in l){(function(t){var u=$("<p>"+t+' - (<a href="#">Recover</a>)</p>');j.append(u);u.find("a").click(function(){var w=[];for(var v=0;v<100;++v){w.push(h.generateAddressFromCustomSeed(t,v).toString())}MyWallet.sweepAddressesModal(w,g)})})(l[r])}k.append(j)}var s=k.find(".send");var q=k.find(".send-options");var i=k.find('select[name="repetitions"]');s.unbind().prop("disabled",true);k.find('input[name="send-value"]').bind("keyup change",function(){n()});q.hide();function m(){var t=q.find("span");t.eq(0).text(formatBTC(h.getMaximumOutputValue()));t.eq(1).text(formatBTC(h.getMinimumOutputValue()));t.eq(2).text(h.getFee());t.eq(3).text(formatBTC(h.getMinimumFee()));q.show()}function n(){var u=parseInt(i.val());if(u>0&&h.getIsEnabled()&&b>=h.getMinimumSupportedVersion()){var t=precisionToSatoshiBN(k.find('input[name="send-value"]').val());if(t.compareTo(BigInteger.valueOf(h.getMinimumOutputValue()))<0){s.prop("disabled",true)}else{if(t.compareTo(BigInteger.valueOf(h.getMaximumOutputValue()))>0){s.prop("disabled",true)}else{s.prop("disabled",false);s.unbind().click(function(){MyWallet.disableLogout(true);var v=function(x){k.find("input,select,button").prop("disabled",false);n();MyWallet.disableLogout(false);MyWallet.makeNotice("error","misc-error",x);c.enableCancel()};var w=function(){k.find("input,select,button").prop("disabled",false);MyWallet.makeNotice("success","misc-success","Sharedcoin Transaction Successfully Completed");MyWallet.disableLogout(false);c.hide();n()};MyWallet.getSecondPassword(function(){loadScript("wallet/signer",function(){c.show();c.disableCancel();var y=precisionToSatoshiBN(k.find('input[name="send-value"]').val());var x=k.find('input[name="send-to-address"]').val();c.setAddressAndAmount(x,y);k.find("input,select,button").prop("disabled",true);h.constructPlan(k,function(z){console.log("Created Plan");console.log(z);z.execute(w,v)},v)},v)},v)})}}}else{s.prop("disabled",true)}}if($.isEmptyObject(d)){MyWallet.setLoadingText("Fetching SharedCoin Info");$.ajax({dataType:"json",type:"POST",url:a,data:{method:"get_info",format:"json"},success:function(v){try{d=v;if(!h.getIsEnabled()){throw"Shared Coin is currently disabled"}if(b<h.getMinimumSupportedVersion()){throw"Version out of date. Please update your client or reload the page."}m();i.empty();for(var t=v.recommended_min_iterations;t<=v.recommended_max_iterations;t+=1){i.append('<option value="'+(t)+'">'+(t)+" Repetitions (Fee: "+((t)*h.getFee()).toFixed(3)+"%)</option>")}i.val(v.recommended_iterations)}catch(u){MyWallet.makeNotice("error","misc-error",u)}n()},error:function(t){s.prop("disabled",true);MyWallet.makeNotice("error","misc-error",t.responseText)}})}else{m()}}};