var AccountSettings=new function(){function b(m){var l=m.lastIndexOf("@");var k=m.lastIndexOf(".");return(l<k&&l>0&&m.indexOf("@@")==-1&&k>2&&(m.length-k)>2)}function h(k,o,m,n,l){m=$.trim(m);if(m.length==0){MyWallet.makeNotice("error","misc-error",k+": Invalid value");return}if(m.length==0){MyWallet.makeNotice("error",o+"-error",data.responseText);if(l){l()}return}MyWallet.setLoadingText(k);MyWallet.securePost("wallet",{length:(m+"").length,payload:m+"",method:o}).success(function(p){MyWallet.makeNotice("success",o+"-success",p);if(n){n()}}).error(function(p){MyWallet.makeNotice("error",o+"-error",p.responseText);if(l){l()}})}function g(){if(MyWallet.getDoubleEncryption()){$(".double-encryption-off").hide();$(".double-encryption-on").show()}else{$(".double-encryption-on").hide();$(".double-encryption-off").show()}$("#double-password").val("");$("#double-password2").val("")}function j(){$("#password_mnemonic1").find("span").empty();$("#password_mnemonic2").find("span").empty()}function e(){j();var l=$("#password_mnemonic1");var k=$("#password_mnemonic2");loadScript("wallet/mnemonic.js",function(){MyWallet.getMainPassword(function(m){MyWallet.getSecondPassword(function(n){try{l.show().find("span").text(mn_encode_pass(m));if(n){k.show().find("span").text(mn_encode_pass(n))}else{k.hide()}}catch(o){console.log(o);d()}},function(){d()})},function(){d()})})}this.bind=function(){g();c();a()};this.init=function(k,m,l){MyWallet.setLoadingText("Loading Account Settings");if(!k.is(":empty")){AccountSettings.bind();m();return}$.get(root+"wallet/account-settings-template").success(function(n){try{k.html(n);AccountSettings.bind();m()}catch(o){console.log(o);l()}}).error(function(){MyWallet.makeNotice("error","misc-error","Error Downloading Account Settings Template");l()})};function a(){$('a[data-toggle="tab"]').unbind().on("show",function(k){$(k.target.hash).trigger("show")});MyWallet.setLoadingText("Getting Wallet Info");MyWallet.securePost("wallet",{method:"get-info"}).success(function(q){if(q.email!=null){$("#wallet-email").val(q.email);$(".my-email").text(q.email)}$("#wallet-phrase").val(q.phrase);$("#two-factor-select").val(q.auth_type);$(".two-factor").hide();$(".two-factor.t"+q.auth_type).show(200);var r=$("#notifications-type");r.find(":checkbox").prop("checked",false);r.find('[class^="type"]').hide();for(var s in q.notifications_type){var t=q.notifications_type[s];r.find(':checkbox[value="'+t+'"]').prop("checked",true);r.find(".type-"+t).show()}$(".logl").hide();$(".logl.l"+q.logging_level).show();$("#logging-level").val(q.logging_level);$("#notifications-confirmations").val(q.notifications_confirmations);$("#notifications-on").val(q.notifications_on);if(q.alias!=null&&q.alias.length>0){$("#wallet-alias").val(q.alias);$(".alias").text("https://blockchain.info/wallet/"+q.alias);$(".alias").show(200)}var l=$("#local_currency").empty();for(var u in q.currencies){var x=q.currencies[u];l.append('<option value="'+u+'">'+x+"</option>")}l.val(q.currency);var o=$("#language_select").empty();for(var p in q.languages){var w=q.languages[p];o.append('<option value="'+p+'">'+w+"</option>")}o.val(q.language);if(q.auto_email_backup==1){$("#auto-email-backup").prop("checked",true)}else{$("#auto-email-backup").prop("checked",false)}if(q.never_save_auth_type==1){$("#never-save-auth-type").prop("checked",true)}else{$("#never-save-auth-type").prop("checked",false)}if(q.google_secret_url!=null&&q.google_secret_url.length>0){loadScript("wallet/qr.code.creator.js",function(){try{var y=makeQRCode(300,300,1,q.google_secret_url);$("#wallet-google-qr").empty().append(y)}catch(z){MyWallet.makeNotice("error","misc-error",z)}})}$("#wallet-http-url").val(q.http_url);$("#wallet-skype").val(q.skype_username);$("#wallet-boxcar").val(q.boxcar_email);$("#wallet-yubikey").val(q.yubikey);if(q.password_hint1){$("#password-hint1").val(q.password_hint1)}if(q.password_hint2){$("#password-hint2").val(q.password_hint2)}$("#ip-lock").val(q.ip_lock);$("#my-ip").text(q.my_ip);if(q.ip_lock_on==1){$("#ip-lock-on").prop("checked",true)}else{$("#ip-lock-on").prop("checked",false)}$('input[name="fee-policy"]').each(function(){if(parseInt($(this).val())==MyWallet.getFeePolicy()){$(this).attr("checked",true)}});$('input[name="inactivity-logout-time"]').each(function(){if(parseInt($(this).val())==MyWallet.getLogoutTime()){$(this).attr("checked",true)}});if(q.email_verified==0){$("#verify-email").show();$("#email-verified").hide()}else{$("#verify-email").hide();$("#email-verified").show()}$("#my-ip").text(q.my_ip);var k="1";if(q.sms_number){var n=q.sms_number.split(" ");if(q.sms_number[0]=="+"&&n.length>1){k=n[0].substring(1);$(".wallet-sms").val(n[1])}else{$(".wallet-sms").val(q.sms_number)}}if(q.sms_verified==0){$(".sms-unverified").show();$(".sms-verified").hide()}else{$(".sms-verified").show().trigger("show");$(".sms-unverified").hide()}$.get(resource+"wallet/country_codes.html").success(function(y){$('select[class="wallet-sms-country-codes"]').html(y).val(k)}).error(function(){MyWallet.makeNotice("error","misc-error","Error Downloading SMS Country Codes")});var v=function(C,z,A){try{if(window.webkitNotifications&&navigator.userAgent.indexOf("Chrome")>-1){var y=webkitNotifications.checkPermission();if(y==1&&A){webkitNotifications.requestPermission(v)}else{if(y==0){C()}else{z()}}}else{if(window.Notification){if(Notification.permissionLevel()==="default"&&A){Notification.requestPermission(v)}else{if(window.Notification.permissionLevel()=="granted"){C()}else{z()}}}else{z()}}}catch(B){console.log(B);z()}};var m=$("#html5-notifications-checkbox");m.unbind().change(function(){if($(this).is(":checked")){v(function(){MyWallet.makeNotice("success","misc-success","HTML5 Notifications Enabled");MyWallet.setHTML5Notifications(true);MyWallet.backupWallet()},function(){MyWallet.makeNotice("error","misc-error","Error Enabling HTML5 Notifications");MyWallet.setHTML5Notifications(false);MyWallet.backupWallet()},true)}else{MyWallet.setHTML5Notifications(false);MyWallet.backupWallet()}});if(MyWallet.getHTML5Notifications()){m.attr("checked",true)}else{m.attr("checked",false)}}).error(function(k){MyWallet.makeNotice("error","misc-error",k.responseText)})}function i(){d();var k=$("#update-password-modal");k.modal({keyboard:true,backdrop:"static",show:true});k.center();k.find(".btn.btn-primary").unbind().click(function(){k.modal("hide");var l=$.trim($("#password").val());var m=$.trim($("#password2").val());if(l!=m){MyWallet.makeNotice("error","misc-error","Passwords do not match.");return false}if(l.length==0||l.length<10||l.length>255){MyWallet.makeNotice("error","misc-error","Password length must be between least 10  & 255 characters");return false}MyWallet.setMainPassword(l)});k.find(".btn.btn-secondary").unbind().click(function(){k.modal("hide")})}function d(){$(".accordion-body").collapse("hide")}function f(l){var k=$("#double-password").val();var m=$("#double-password2").val();if(k==null||k.length==0||k.length<4||k.length>255){MyWallet.makeNotice("error","misc-error","Password must be 4 characters or more in length");return}if(k!=m){MyWallet.makeNotice("error","misc-error","Passwords do not match.");return}if(MyWallet.isCorrectMainPassword(k)){MyWallet.makeNotice("error","misc-error","Second password should not be the same as your main password.");return}MyWallet.setDoubleEncryption(l,k,function(){g()})}function c(){var k=$("#notifications-type");k.find(":checkbox").unbind().change(function(){var n=[];k.find(":checkbox:checked").each(function(){n.push($(this).val())});if(!n.length){n.push(0)}h("Updating Notifications Type","update-notifications-type",n.join("|"));k.find(".type-"+$(this).val()).toggle();MyWallet.get_history()});$("input[name=fee-policy]").unbind().change(function(){MyWallet.setFeePolicy($("input[name=fee-policy]:checked").val());MyWallet.backupWallet()});$("input[name=inactivity-logout-time]").unbind().change(function(){MyWallet.setLogoutTime(parseInt($(this).val()));MyWallet.backupWallet()});$("#password_mnemonic").unbind().on("show",function(){e()}).on("hide",function(){j()});$("#pairing_code").unbind().on("show",function(){var n=$("#device-qr-code");n.empty();MyWallet.makePairingQRCode(function(o){n.empty().append(o);setTimeout(function(){n.empty();d()},30000)})});$("#update-password-btn").unbind().click(function(){i()});$("#password-hint1").unbind().change(function(){h("Updating Main Password Hint","update-password-hint1",$(this).val())});$("#password-hint2").unbind().change(function(){h("Updating Second Password Hint","update-password-hint2",$(this).val())});$("#ip-lock-on").unbind().change(function(){h("Updating IP Lock","update-ip-lock-on",$(this).is(":checked"))});$("#ip-lock").unbind().change(function(){h("Updating Locked Ip Addresses","update-ip-lock",$(this).val())});$("#notifications-on").unbind().change(function(){h("Updating Notifications Settings","update-notifications-on",$(this).val())});$("#auto-email-backup").unbind().change(function(){h("Updating Auto Backup Settings","update-auto-email-backup",$(this).is(":checked"))});$("#never-save-auth-type").unbind().change(function(){h("Updating Auth Saving Settings","update-never-save-auth-type",$(this).is(":checked"))});$("#two-factor-select").unbind().change(function(){var n=parseInt($(this).val());h("Updating Two Factor Authentication","update-auth-type",n,function(){if(n==4){a()}MyWallet.updateCacheManifest()});$(".two-factor").hide(200);$(".two-factor.t"+n).show(200)});var l="";$("#wallet-email-send").click(function(){l="";$("#wallet-email").trigger("change")});$("#wallet-email").unbind().change(function(o){var n=$.trim($(this).val());if(n.length==0){return}if(l==n){return}if(!b(n)){MyWallet.makeNotice("error","misc-error","Email address is not valid");return}h("Updating Email","update-email",n,function(){l=n},function(){l=""});l=n;$("#verify-email").show(200);$("#email-verified").hide()});$("#wallet-double-encryption-enable").unbind().click(function(n){d();f(true)});$("#wallet-double-encryption-disable").unbind().click(function(n){d();f(false)});$("#wallet-email-code").unbind().change(function(o){var n=$.trim($(this).val());if(n.length==0||n.length>255){MyWallet.makeNotice("error","misc-error","You must enter a code to verify");return}MyWallet.setLoadingText("Verifying Email");MyWallet.securePost("wallet",{payload:n,length:n.length,method:"verify-email"}).success(function(p){MyWallet.makeNotice("success","misc-success",p);$("#verify-email").hide();$("#email-verified").show(200)}).error(function(p){MyWallet.makeNotice("error","misc-error",p.responseText);$("#verify-email").show(200);$("#email-verified").hide()})});$(".wallet-sms-code").unbind().change(function(o){var n=$.trim($(this).val());if(n.length==0||n.length>255){MyWallet.makeNotice("error","misc-error","You must enter an SMS code to verify");return}MyWallet.setLoadingText("Verifying SMS Code");MyWallet.securePost("wallet",{payload:n,length:n.length,method:"verify-sms"}).success(function(p){MyWallet.makeNotice("success","misc-success",p);$(".sms-unverified").hide();$(".sms-verified").show(200).trigger("show")}).error(function(p){MyWallet.makeNotice("error","misc-error",p.responseText);$(".sms-verified").hide();$(".sms-unverified").show(200)})});var m="";$(".send-code").unbind().click(function(){m="";$(this).parent().find(".wallet-sms").trigger("change")});$('select[class="wallet-sms-country-codes"]').unbind().change(function(){m="";$(".wallet-sms").trigger("change")});$(".wallet-sms").unbind().change(function(){var n=$.trim($(this).val());if(n==null||n.length==0){return}if(n.charAt(0)!="+"){n="+"+$(".wallet-sms-country-codes").val()+n}if(m==n){return}m=n;h("Updating Cell Number","update-sms",n,function(){$(".sms-unverified").show(200);$(".sms-verified").hide()})});$("#run-key-check").unbind().click(function(){MyWallet.getSecondPassword(function(){try{MyWallet.checkAllKeys(true);MyWallet.backupWallet()}catch(n){MyWallet.makeNotice("error","misc-error",n)}})});$("#local_currency").unbind().change(function(){if(symbol!=symbol_local){toggleSymbol()}h("Updating Local Currency","update-currency",$(this).val(),function(){MyWallet.get_history()})});$("#language_select").unbind().change(function(){h("Updating Language","update-language",$(this).val(),function(){MyWallet.updateCacheManifest(function(){window.location.reload()})})});$("#notifications-confirmations").unbind().change(function(n){h("Updating Notification Confirmations","update-notifications-confirmations",$(this).val())});$("#account-logging").unbind().on("show",function(){var o=$(this).find("table").hide();var n=o.find("tbody");MyWallet.securePost("wallet",{method:"list-logs"}).success(function(t){try{o.show();n.empty();if(t==null){throw"Failed to get backups"}var r=t.results;if(r.length==0){throw"No logs found"}for(var q in r){var p=r[q];n.append('<tr><td style="width:130px">'+dateToString(new Date(p.time))+'</td><td style="width:170px">'+p.action+'</td><td style="text-overflow: ellipsis;max-width:100px;overflow: hidden;">'+p.ip_address+"</td><td>"+p.user_agent+"</td></tr>")}}catch(s){MyWallet.makeNotice("error","misc-error",s)}}).error(function(p){MyWallet.makeNotice("error","misc-error",p.responseText)})});$("#logging-level").unbind().change(function(n){$(".logl").hide();$(".logl.l"+$(this).val()).show();h("Updating Logging Level","update-logging-level",$(this).val(),function(){$("#account-logging").trigger("show")})});$("#wallet-yubikey").unbind().change(function(n){h("Updating Yubikey","update-yubikey",$(this).val())});$("#wallet-skype").unbind().change(function(n){h("Updating Skype Username","update-skype",$(this).val())});$("#wallet-boxcar").unbind().change(function(n){h("Updating Boxcar Email","update-boxcar",$(this).val())});$("#wallet-http-url").unbind().change(function(n){h("Updating HTTP url","update-http-url",$(this).val())});$("#wallet-phrase").unbind().change(function(o){var n=$.trim($(this).val());if(n==null||n.length==0||n.length>255){MyWallet.makeNotice("error","misc-error","You must enter a secret phrase");return}h("Updating Secret Phrase","update-phrase",n)});$("#wallet-alias").unbind().change(function(q){var p=$(this);var n=$.trim(p.val());p.val(p.val().replace(/[\.,\/ #!$%\^&\*;:{}=`~()]/g,""));var o=$.trim(p.val());if(o.length>0){$(".alias").fadeIn(200);$(".alias").text("https://blockchain.info/wallet/"+o)}h("Updating Alias","update-alias",o,null,function(){p.val(n)})})}};